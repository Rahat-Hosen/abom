[[extend 'layout.html']]

[[block header]]
[[icon='fa fa-chart-line']]
[[breadcamp = 'Book Page']]
[[end]]

[[block content]]
<style>
    #table_id tr td,
    table th td {
        white-space: normal !important;
    }

    .input-container {
        margin-bottom: 20px;
    }

    .input-container label {
        display: block;
        margin-bottom: 5px;
    }

    .input-container input {
        width: 100px;
        padding: 5px;
    }

    #grid-container {
        display: grid;
        grid-template-columns: repeat(16, 1fr);
        /* 16 to support half-columns */
        gap: 0px;
        width: 21.2rem;
        border: 1px solid rgba(204, 201, 250);
        position: relative;
    }

    .grid-item {
        height: 10px;
        /* Adjusted for half-inch rows */
        box-sizing: border-box;
        /* transition: background-color 0.3s; */
    }

    /* Rows */
    .grid-item.solid {
        border-top: 2px solid rgba(204, 201, 250);
        /* Solid top border for whole-inch rows */
    }

    .grid-item.dotted {
        border-top: 1px dotted #e7e7e7;
        /* Dotted top border for half-inch rows */
    }

    /* Columns */
    .grid-item.col-solid {
        border-left: 2px solid rgba(204, 201, 250);
        /* Solid left border for whole-inch columns */
    }

    .grid-item.col-dotted {
        border-left: 1px dotted #e7e7e7;
        /* Dotted left border for half-inch columns */
    }

    .selected {
        background-color: rgba(204, 201, 250);
    }

    .selection-overlay {
        position: absolute;
        background-color: rgb(230, 229, 250);
        color: #000000;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 8px;
        font-weight: bold;
        text-align: center;
        /* text-shadow: 1px 1px 2px rgba(204, 201, 250); */
        cursor: move;
        pointer-events: auto;
        z-index: 10;
        box-sizing: border-box;
        padding: 5px;
        border: rgb(181, 176, 248) 2px solid;
    }

    .selection-overlay.overflow {
        border-color: red !important;
    }

    .col-md-customs {
        flex: 0 0 auto;
        width: 18%;
    }

    .layout.fixed-sidebar .sidebar~.layout {
        overflow: scroll;
    }
</style>
<div class="container-section">
    <div class="d-flex justify-content-between align-items-center border-bottom">
        <span class="icon-text icon-text-bold">
            <i class="fa-solid fa-plus"></i>
            <span>Create</span>
        </span>

        <div class="d-flex justify-content-end">
            <div class="p-1">
                <!--<button type="button" onclick="window.history.back()"  class="btn btn-sm btn-light">
                    <i class="fa-solid fa-arrow-left"></i> <span class="ms-2">Back</span>
                </button>-->
                <a href="[[=URL('book_page/index')]]" class="btn btn-sm btn-light">
                    <i class="fa-solid fa-arrow-left"></i> <span class="ms-2">Back</span>
                </a>
            </div>
        </div>
    </div>
    <div class="container ">
        <form action="[[=URL('book_page','submit')]]" method="POST" id="book_page_form">
            <div id="custom_form">
                <div class="row">
                    <div class="col-md-8">
                        <!-- start scrollable -->
                        <div class="" style="height: 100%; overflow-y: scroll; overflow-x: hidden;">
                            <!-- Start Booking Information -->
                            <span class="text-center fw-bold p-1 my-2 d-block rounded-1"
                                style="color: #4f5762; background-color: var(--master-primary-light) !important;">Booking
                                Information</span>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="booking_date" class="form-label">Booking Date</label>
                                        <input type="date" id="booking_date" name="booking_date" class="form-control">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="publish_date" class="form-label">Publish Date</label>
                                        <input type="date" id="publish_date" name="publish_date" class="form-control">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mt-4">
                                        <button type="button" class="btn btn-primary" style="width: -webkit-fill-available;" data-bs-toggle="offcanvas"
                                            data-bs-target="#offcanvasWithBothOptions"
                                            aria-controls="offcanvasWithBothOptions">
                                            <i class="fa-regular fa-plus"></i> <span class="ms-2 multidatevalue">Add
                                                Date [0 Day/s]</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="news_supplement" class="form-label">News Supplement</label>
                                        <select class="select_custom form-control form-select-sm selectChange" id="news_supplement2"
                                            name="news_supplement">
                                            <option value="">Select News supplement</option>
                                             [[ for row in alldays_items:]]
                                            <option>[[=row.news_supplement]]</option>
                                            [[pass]]
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="page_type" class="form-label"> Page Type</label>
                                        <select class="select_custom form-control form-select-sm selectChange"
                                            name="page_type" id="page_type2">
                                            <option value="">Select Page Type</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="page_name" class="form-label"> Page Name</label>
                                        <select class="select_custom form-control form-select-sm selectChange"
                                            name="page_name" id="page_name2">
                                            <option value="">Select Page Name</option>
                                        </select>
                                    </div>
                                </div>
                               
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="customer_id" class="form-label">ID</label>
                                        <select class="select_custom form-control form-select-sm selectChange"
                                            name="customer_id">
                                            <option value="">Select Customer Id</option>
                                            [[ for row in customer_ids:]]
                                            <option>[[=row.accpac_id]]</option>
                                            [[pass]]
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="customer_name" class="form-label">Customer Name</label>
                                        <select class="select_custom form-control form-select-sm selectChange"
                                            name="customer_name">
                                            <option value="">Select Customer Name</option>
                                            [[ for row in customer_names:]]
                                            <option>[[=row.name]]</option>
                                            [[pass]]
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="customer_type" class="form-label">Customer Type</label>
                                        <select class="select_custom form-control form-select-sm selectChange"
                                            name="customer_type">
                                            <option value="">Select Customer Type</option>
                                            [[ for row in customer_types:]]
                                            <option>[[=row.name]]</option>
                                            [[pass]]
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="brand" class="form-label">Brand</label>
                                        <select class="select_custom form-control form-select-sm selectChange"
                                         id="brand"   name="brand">
                                            <option value="">Select Brand</option>
                                            [[ for row in brands:]]
                                            <option>[[=row.name]]</option>
                                            [[pass]]
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="advertiser" class="form-label">Advertiser</label>
                                        <select class="select_custom form-control" id="advertiser" name="advertiser">
                                            <option value="">Select</option>           
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="adv_sector" class="form-label">Adv. Sector</label>
                                        <select class="select_custom form-control" id="adv_sector" name="adv_sector">
                                            <option value="">Select</option>            
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="reference" class="form-label">Reference</label>
                                        <input type="text" id="reference" name="reference" class="form-control">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="title" class="form-label">Title</label>
                                        <input type="text" id="title" name="title" class="form-control">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="region" class="form-label">Region</label>
                                        <select class="select_custom form-control form-select-sm selectChange"
                                            name="region">
                                            <option value="">Select Region Name</option>
                                            [[ for row in utils_region:]]
                                            <option>[[=row.name]]</option>
                                            [[pass]]
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <!-- End Booking Information -->

                            <!-- Start Pricing Information -->
                            <span class="text-center fw-bold p-1 my-2 d-block rounded-1"
                                style="color: #4f5762; background-color: var(--master-primary-light) !important;">Pricing
                                Information
                            </span>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="payment_type" class="form-label">Payment Type</label>
                                        <select class="select_custom form-control form-select-sm selectChange"
                                            name="payment_type">
                                            <option value="">Select Payment Type</option>
                                            <option value="Cash">Cash</option>
                                            <option value="Credit">Credit</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="inches" class="form-label">Inches (0-20.5)</label>
                                        <input type="number" id="inches" min="0" max="20.5" step="0.5" value="3"
                                            name="inch" class="form-control">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="columns" class="form-label">Columns (0-8)</label>
                                        <input type="number" id="columns" min="0" max="8" step="0.5" value="4"
                                            name="col" class="form-control">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="credit_limit" class="form-label">Credit Limit</label>
                                        <input type="text" id="credit_limit" name="credit_limit" class="form-control">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="outstanding" class="form-label">Outstanding</label>
                                        <input type="text" id="outstanding" name="outstanding" class="form-control">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="availed" class="form-label">Availed</label>
                                        <input type="text" id="availed" name="availed" class="form-control">
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="mb-3">
                                        <label for="color_type" class="form-label">Color Type</label>
                                        <select class="select_custom form-control form-select-sm selectChange"
                                            name="color_type" id="color_type">
                                            <option value="">Select color Type</option>
                                            <option value="Color">Color</option>
                                            <option value="Black & White">Black & White</option>
                                        </select>

                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="mb-3">
                                        <label for="unit_price" class="form-label">Rate</label>
                                        <input type="text" id="unit_price" name="rate" class="form-control"  readonly>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="mb-3">
                                        <label for="subtotal" class="form-label">Subtotal</label>
                                        <input type="text" id="subtotal" name="subtotal" class="form-control" readonly>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="mb-3">
                                        <label for="discount_percentage" class="form-label">Discount(%)</label>
                                        <input type="text" id="discount_percentage" name="discount_percentage"
                                            class="form-control">
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="mb-3">
                                        <label for="discount_amount" class="form-label">Discount</label>
                                        <input type="text" id="discount_amount" name="discount_amount" readonly
                                            class="form-control">
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="mb-3">
                                        <label for="gross_total" class="form-label">Gross Total</label>
                                        <input type="text" id="gross_total" name="gross_total" class="form-control" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mt-6">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="specific_input"
                                                name="specific_input">
                                            <label class="form-check-label" for="specific_input">Specific</label>
                                        </div>
                                        <input type="text" id="specific" name="specific" class="form-control" readonly>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mt-6">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="box_input"
                                                name="box_input">
                                            <label class="form-check-label" for="box_input">Box</label>
                                        </div>
                                        <input type="text" id="box" name="box" class="form-control" readonly>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="additional_charge" class="form-label">Additonal Charge</label>
                                        <input type="text" id="additional_charge" name="additional_charge" readonly
                                            class="form-control">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-2">
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="vat_input"
                                                name="vat_input">
                                            <label class="form-check-label" for="vat_input">Vat</label>
                                        </div>
                                        <input type="text" id="vat" name="vat" value="0" class="form-control" readonly>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="mb-3">
                                        <label for="vat_amount" class="form-label">Vat Amount</label>
                                        <input type="text" id="vat_amount" name="vat_amount" readonly
                                            class="form-control">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mt-6">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="fixed_rate_input"
                                                name="fixed_rate_input">
                                            <label class="form-check-label" for="fixed_rate_input">Fixed Rate</label>
                                        </div>
                                        <input type="text" id="fixed_rate" name="fixed_rate" class="form-control"
                                            readonly>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="net_total" class="form-label">Net Total</label>
                                        <input type="text" id="net_total" name="net_total" class="form-control" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-2">


                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="confused_field" class="form-label">Confused Field</label>
                                        <select class="select_custom form-control form-select-sm selectChange"
                                            name="confused_field" multiple>
                                            <option value="">Select Confused Field</option>
                                            <option value="customer_type">Customer Type</option>
                                            <option value="brand">Brand</option>
                                            <option value="adv_category">Adv. Category</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="status" class="form-label">Status</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="1" checked
                                                id="status" name="status">
                                            <label class="form-check-label" for="status">
                                                Active
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- End Pricing Information -->
                        </div>
                        <!-- end scrollable -->
                    </div>
                    <!-- Start News Grid Layout -->
                    <div class="col-md-4">
                        <span class="text-center fw-bold p-1 my-2 d-block rounded-1"
                            style="color: #4f5762; background-color: var(--master-primary-light) !important;">
                            Layout
                        </span>
                        <div id="grid-container">
                            <!-- Insert your interactive grid layout here -->
                        </div>
                    </div>
                    <!-- End News Grid Layout -->
                </div>
            </div>
          
            <br>
            <div class="row">
                <div class="col-12" style="margin-left: 10px;">
                    <div class="d-flex justify-content-start">
                        <div class="me-2">
                            <button type="submit" class="btn btn-sm btn-secondary">
                                <i class="fa-regular fa-floppy-disk"></i> <span class="ms-2">Add</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <input type="text" hidden name="ad_multi">
        </form>
    </div>

</div>
[[end]]
<!--  drawer -->
[[block drawer]]
<div class="offcanvas offcanvas-end" data-bs-scroll="true" tabindex="-1" id="offcanvasWithBothOptions"
    aria-labelledby="offcanvasWithBothOptionsLabel">
    <div class="d-flex  justify-content-between align-items-center border-bottom">
        <span class="icon-text icon-text-bold" style="margin-left: 10px;">
            <i class="fa-solid fa-plus"></i>
            <span>Create</span>
        </span>

        <div class="d-flex justify-content-end">
            <div class="p-1">
                <button type="button" class="btn btn-sm btn-light" data-bs-dismiss="offcanvas" aria-label="Close"></i>
                    <i class="fa-solid fa-close" data-bs-dismiss="offcanvas" aria-label="Close"></i> <span
                        class="ms-2">Close</span></button>

            </div>
        </div>
    </div>


    <div class="offcanvas-body">
        <div>
            <div class="d-flex  justify-content-between align-items-center ">
                <span class="enter fw-bold p-1 text-sm-center my-2 d-block rounded-1"
                    style=" width: 780px; color:  #4f5762; background-color: var(--master-primary-light) !important;">Multiple
                    Date Advertise [0 day/s]
                </span>
            </div>

            <div class="row-container">
                <!-- Your form row goes here (the one you've already created) -->
                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="start_date" class="form-label">From Date</label>
                            <input type="date" id="start_date" name="start_date[]" class="form-control">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="end_date" class="form-label">To Date</label>
                            <input type="date" id="end_date" name="end_date[]" class="form-control">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-3">
                            <label for="news_supplement" class="form-label">News Supplement</label>
                                        <select class="select_custom form-control form-select-sm selectChange" id="news_supplement"
                                            name="news_supplement">
                                            <option value="">Select News supplement</option>
                                             [[ for row in alldays_items:]]
                                            <option>[[=row.news_supplement]]</option>
                                            [[pass]]
                                        </select>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-3">
                            <label for="page_type" class="form-label">Page Type</label>
                            <select class="select_custom form-control" id="page_type" name="page_type[]">
                                <option value="">Select</option>

                            </select>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-3">
                            <label for="page_name" class="form-label">Page Name</label>
                            <select class="select_custom form-control" id="page_name" name="page_name[]">
                                <option value="">Select</option>
                            </select>
                        </div>
                    </div>
                   <input type="text" id="unit_price2" name="rate" class="form-control"  readonly>
                   <input type="text" id="subtotal2" name="subtotal" class="form-control" readonly>
                   <input type="text" id="discount_percentage2" name="discount_percentage" class="form-control">
                   <input type="text" id="discount_amount2" name="discount_amount" readonly class="form-control">
                   <input type="text" id="gross_total2" name="gross_total" class="form-control" readonly>
                   <input type="text" id="specific2" name="specific" class="form-control" readonly>
                   <input type="text" id="box2" name="box" class="form-control" readonly>
                   <input type="text" id="additional_charge2" name="additional_charge" readonly class="form-control">
                   <input type="text" id="vat2" name="vat" value="0" class="form-control" readonly>
                   <input type="text" id="vat_amount2" name="vat_amount" readonly class="form-control">
                   <input type="text" id="fixed_rate2" name="fixed_rate" class="form-control" readonly>
                   <input type="text" id="net_total2" name="net_total" class="form-control" readonly>
                </div>
                <div class="row">
                    <div class="col-md-customs ">
                        <div class="mb-3">
                            <button type="button" class="btn btn-primary " id="previewBtn">
                                <i class="fa-regular fa-add"></i> <span class="ms-2">Add Queue</span>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-3 ">
                        <div class="mb-3">
                            <button type="button" class="btn btn-secondary " id="clearBtn">
                                <i class="fa-regular fa-trash-can"></i> <span class="ms-2">Clear Data</span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="d-flex  justify-content-between align-items-center ">
                    <span class=" fw-bold p-1 text-sm-center my-2 d-block rounded-1"
                        style=" width: 780px; color:  #4f5762; background-color: var(--master-primary-light) !important;">Preview
                    </span>
                </div>
                <!-- Table to display the generated rows -->
                <table class="table table-bordered mt-3" id="previewTable">
                    <thead>
                        <tr>
                            <th>Publish Date</th>
                            <th>News/ Supplement</th>
                            <th>Page Type</th>
                            <th>Page Name</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dynamic rows will be inserted here -->
                    </tbody>
                </table>

            </div>
        </div>
</div>
    [[end]]

    [[block scripts]]
    <!-- individual pages can add scripts here -->
    <script>

        // Grid Layout

        $(document).ready(function () {
            const $gridContainer = $('#grid-container');
            const $columnsInput = $('#columns');
            const $inchesInput = $('#inches');

            const totalColumns = 16;
            const totalInches = 20.5;
            const totalRows = Math.ceil(totalInches * 2);

            let selectedArea = { col: 2, row: 2, width: 5, height: 5 };

            let isDragging = false;
            let startCol, startRow, startMouseX, startMouseY;

            function createGrid() {
                for (let i = 0; i < totalRows * totalColumns; i++) {
                    const rowIndex = Math.floor(i / totalColumns);
                    const colIndex = i % totalColumns;

                    const $gridItem = $('<div>', { class: 'grid-item' });

                    if (rowIndex % 2 === 0) {
                        $gridItem.addClass('solid');
                    } else {
                        $gridItem.addClass('dotted');
                    }

                    if (colIndex % 2 === 0) {
                        $gridItem.addClass('col-solid');
                    } else {
                        $gridItem.addClass('col-dotted');
                    }

                    $gridItem.appendTo($gridContainer);
                }
            }

            function renderArea() {
                $gridContainer.find('.grid-item').removeClass('selected');
                $gridContainer.find('.selection-overlay').remove();

                const cellWidth = $gridContainer.width() / totalColumns;
                const cellHeight = $('.grid-item').first().outerHeight(true);
                const width = selectedArea.width * 2 * cellWidth;
                const height = selectedArea.height * cellHeight;
                const left = selectedArea.col * 2 * cellWidth;
                const top = selectedArea.row * cellHeight;
                $('<div>', {
                    class: `selection-overlay`,
                    text: `BKN: ID (${selectedArea.width} x ${selectedArea.height / 2})`,
                    css: { width, height, left, top }
                }).appendTo($gridContainer);

                for (let i = 0; i < selectedArea.height; i++) {
                    for (let j = 0; j < selectedArea.width * 2; j++) {
                        const gridIndex = (selectedArea.row + i) * totalColumns + (selectedArea.col * 2 + j);
                        $('.grid-item').eq(gridIndex).addClass('selected');
                    }
                }
            }

            function updateGrid() {
                const selectedColumns = Math.min(Math.max(0, Math.round(parseInt($columnsInput.val()) * 2) / 2 || 0), 8);
                const selectedInches = Math.min(Math.max(0, Math.round(parseInt($inchesInput.val()) * 2) / 2 || 0), totalInches);
                const selectedRows = Math.ceil(selectedInches * 2);

                selectedArea.width = selectedColumns;
                selectedArea.height = selectedRows;
                renderArea();
            }

            function onDragStart(e) {
                const $target = $(e.target);
                if ($target.hasClass('selection-overlay')) {
                    isDragging = true;
                    const rect = $gridContainer[0].getBoundingClientRect();
                    const cellWidth = rect.width / totalColumns;
                    const cellHeight = rect.height / totalRows;

                    startMouseX = e.clientX;
                    startMouseY = e.clientY;
                    startCol = selectedArea.col;
                    startRow = selectedArea.row;

                    $(document).on('mousemove', onDrag);
                    $(document).on('mouseup', onDragEnd);

                    $columnsInput.val(selectedArea.width);
                    $inchesInput.val(selectedArea.height / 2);
                }
            }

            function onDrag(e) {
                if (!isDragging) return;

                const rect = $gridContainer[0].getBoundingClientRect();
                const cellWidth = rect.width / totalColumns;
                const cellHeight = rect.height / totalRows;

                const dx = Math.floor((e.clientX - startMouseX) / cellWidth);
                const dy = Math.floor((e.clientY - startMouseY) / cellHeight);

                const newCol = Math.max(0, Math.min(startCol + dx / 2, totalColumns / 2 - selectedArea.width));
                const newRow = Math.max(0, Math.min(startRow + dy, totalRows - selectedArea.height));

                selectedArea.col = newCol;
                selectedArea.row = newRow;

                renderArea();
            }

            function onDragEnd() {
                isDragging = false;
                $(document).off('mousemove', onDrag);
                $(document).off('mouseup', onDragEnd);
            }

            $columnsInput.on('input', updateGrid);
            $inchesInput.on('input', updateGrid);
            $gridContainer.on('mousedown', onDragStart);

            createGrid();
            renderArea();

            // End Grid Layout

        function addDays(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = ('0' + (date.getMonth() + 1)).slice(-2);
            const day = ('0' + date.getDate()).slice(-2);
            return `${year}-${month}-${day}`;
        }

        $('#publish_date').change(function() {
            const publishDateValue = $(this).val();
            if (publishDateValue) {
                const publishDate = new Date(publishDateValue);
                const nextDay = addDays(publishDate, 1);

                $('#start_date').attr('min', formatDate(nextDay));
                $('#end_date').attr('min', formatDate(nextDay));

                const startDateValue = $('#start_date').val();
                const endDateValue = $('#end_date').val();

                if (startDateValue && new Date(startDateValue) < nextDay) {
                    $('#start_date').val('');
                }

                if (endDateValue && new Date(endDateValue) < nextDay) {
                    $('#end_date').val('');
                }
            }
        });


            $('#mySelect').select2({
                placeholder: "Select an option"
            });
            $('#mySelect').on('change', function () {
                if ($(this).find('option:selected').length > 0) {
                    $(this).attr('placeholder', '');
                } else {
                    $(this).attr('placeholder', 'Select option');
                }
            });
            $('#fixed_rate_input').change(function () {
                $('#fixed_rate').prop('readonly', !this.checked);
            });
            $('#box_input').change(function () {
                $('#box').prop('readonly', !this.checked);
            });
            $('#specific_input').change(function () {
                $('#specific').prop('readonly', !this.checked);
            });

            $('#vat_input').change(function() {
                const grossTotal = parseInt($('#gross_total').val()); 

                if (this.checked) {
                    $('#vat').prop('readonly', false); 
                } else {
                    $('#vat').prop('readonly', true); 
                    $('#vat').val(''); 
                    $('#vat_amount').val(0); 
                    $('#net_total').val(grossTotal); 
                }
            });



            $('#news_supplement').on('change', function (e) {
                var selectedValue = $(this).val();
                $.ajax({
                    url: '[[=URL("default", "get_page_type")]]',
                    method: 'GET',
                    data: { news_supplement: selectedValue },
                    dataType: 'json',
                    success: function (data) {
                        var pageTypeDropdown = $('#page_type');
                        pageTypeDropdown.empty();
                        if (data.results.length > 0) {
                            data.results.forEach(function (item) {
                                pageTypeDropdown.append($('<option>', {
                                    value: item.page_type,
                                    text: item.page_type
                                }));
                            });
                            pageTypeDropdown.val(data.results[0].page_type).trigger('change');
                        } else {
                            pageTypeDropdown.append($('<option>', { text: 'No page types available', value: '' }));
                            $('#page_name').empty(); 
                        }
                    },
                    error: function () {
                        alert('Error loading page types');
                    }
                });
            });

            $('#news_supplement2').on('change', function (e) {
                var selectedValue = $(this).val();
                $.ajax({
                    url: '[[=URL("default", "get_page_type")]]',
                    method: 'GET',
                    data: { news_supplement: selectedValue },
                    dataType: 'json',
                    success: function (data) {
                        var pageTypeDropdown = $('#page_type2');
                        pageTypeDropdown.empty();
                        if (data.results.length > 0) {
                            data.results.forEach(function (item) {
                                pageTypeDropdown.append($('<option>', {
                                    value: item.page_type,
                                    text: item.page_type
                                }));
                            });

                            // Automatically trigger the page_type change event for the first option
                            pageTypeDropdown.val(data.results[0].page_type).trigger('change');
                        } else {
                            pageTypeDropdown.append($('<option>', { text: 'No page types available', value: '' }));
                            $('#page_name2').empty();  // Clear page_name if no page types
                        }
                    },
                    error: function () {
                        alert('Error loading page types');
                    }
                });
            });

            $('#page_type').on('change', function (e) {
                var selectedValue = $(this).val();
                if (!selectedValue) return; // Exit if no value is selected

                $.ajax({
                    url: '[[=URL("default", "get_page_name")]]',
                    method: 'GET',
                    data: { page_type: selectedValue },
                    dataType: 'json',
                    success: function (data) {
                        var pageNameDropdown = $('#page_name');
                        pageNameDropdown.empty();

                        if (data.results.length > 0) {
                            data.results.forEach(function (item) {
                                pageNameDropdown.append($('<option>', {
                                    value: item.assign_page,
                                    text: item.assign_page
                                }));
                            });
                        } else {
                            pageNameDropdown.append($('<option>', { text: 'No pages available', value: '' }));
                        }
                    },
                    error: function () {
                        alert('Error loading page names');
                    }
                });
            });
            
            $('#page_type2').on('change', function (e) {
                var selectedValue = $(this).val();
                if (!selectedValue) return; // Exit if no value is selected

                $.ajax({
                    url: '[[=URL("default", "get_page_name")]]',
                    method: 'GET',
                    data: { page_type: selectedValue },
                    dataType: 'json',
                    success: function (data) {
                        var pageNameDropdown = $('#page_name2');
                        pageNameDropdown.empty();

                        if (data.results.length > 0) {
                            data.results.forEach(function (item) {
                                pageNameDropdown.append($('<option>', {
                                    value: item.assign_page,
                                    text: item.assign_page
                                }));
                            });
                        } else {
                            pageNameDropdown.append($('<option>', { text: 'No pages available', value: '' }));
                        }
                    },
                    error: function () {
                        alert('Error loading page names');
                    }
                });
            });

            $('#brand').on('change', function (e) {
                var selectedValue = $(this).val();
                if (!selectedValue) return; // Exit if no value is selected

                $.ajax({
                    url: '[[=URL("default", "get_advertiser")]]',
                    method: 'GET',
                    data: { brand: selectedValue },
                    dataType: 'json',
                    success: function (data) {
                        var advertiserDropdown = $('#advertiser');
                        advertiserDropdown.empty();

                        if (data.results.length > 0) {
                            data.results.forEach(function (item) {
                                advertiserDropdown.append($('<option>', {
                                    value: item.advertiser,
                                    text: item.advertiser
                                }));
                            });
                        } else {
                            advertiserDropdown.append($('<option>', { text: 'No pages available', value: '' }));
                        }
                    },
                    error: function () {
                        alert('Error loading page names');
                    }
                });
            });

            $('#brand').on('change', function (e) {
                var selectedValue = $(this).val();
                if (!selectedValue) return; // Exit if no value is selected

                $.ajax({
                    url: '[[=URL("default", "get_adv_sector")]]',
                    method: 'GET',
                    data: { advertiser: selectedValue },
                    dataType: 'json',
                    success: function (data) {
                        var advertiserDropdown = $('#adv_sector');
                        advertiserDropdown.empty();

                        if (data.results.length > 0) {
                            data.results.forEach(function (item) {
                                advertiserDropdown.append($('<option>', {
                                    value: item.adv_sector,
                                    text: item.adv_sector
                                }));
                            });
                        } else {
                            advertiserDropdown.append($('<option>', { text: 'No pages available', value: '' }));
                        }
                    },
                    error: function () {
                        alert('Error loading page names');
                    }
                });
            });

        }); 


        $('#color_type').on('change', function (e) {
            var colorType = $(this).val();
            var newsSupplement = $('#news_supplement2').val();
            var pageType = $('#page_type2').val();
            var pageName = $('#page_name2').val();
            const inches = parseFloat($('#inches').val());
            const columns = parseFloat($('#columns').val());

            $.ajax({
                url: '[[=URL("default", "get_unit_price")]]',
                method: 'GET',
                data: {
                    news_supplement: newsSupplement,
                    page_type: pageType,
                    page_name: pageName,
                    color_type: colorType,
                    inches: inches,
                    columns: columns,
                },
                dataType: 'json',
                success: function (data) {
                    if (data.unit_price) {
                        $('#unit_price').val(data.unit_price);
                        const subtotal = data.unit_price * inches * columns;
                        $('#subtotal').val(subtotal);
                        calculateVatAndNetTotal(); 
                    } else {
                        alert('Price not found');
                    }
                },
                error: function () {
                    alert('Error retrieving price');
                }
            });
        });

        function calculateVatAndNetTotal() {
            const subtotal = parseFloat($('#subtotal').val()) || 0;
            const discountPercentage = parseFloat($('#discount_percentage').val()) / 100 || 0;
            const vatPercentage = parseFloat($('#vat').val()) / 100 || 0;

            const specificChecked = $('#specific_input').is(':checked');
            const boxChecked = $('#box_input').is(':checked');

            let additionalCharge = 0;
            let specificCharge = parseFloat($('#specific').val()) || 0;
            let boxCharge = parseFloat($('#box').val()) || 0;

            if (specificChecked) {
                additionalCharge += specificCharge; 
            }

            const newSubtotal = subtotal + additionalCharge;

            const discountAmount = newSubtotal * discountPercentage;
            $('#discount_amount').val(discountAmount);

            let grossAmount = subtotal - discountAmount;
            $('#gross_total').val(grossAmount);

            if (boxChecked) {
                additionalCharge += boxCharge; 
            }
            $('#additional_charge').val(additionalCharge);

            let vatAmount = 0;
            if (specificChecked && boxChecked) {
                vatAmount = (subtotal + boxCharge) * vatPercentage;
            } else if (specificChecked) {
                vatAmount = subtotal * vatPercentage;
            } else if (boxChecked) {
                vatAmount = (subtotal + boxCharge) * vatPercentage;
            } else {
                vatAmount = subtotal * vatPercentage;
            }
            $('#vat_amount').val(vatAmount);

            const netTotalPrice = grossAmount + vatAmount + additionalCharge;
            $('#net_total').val(netTotalPrice);
        }

        $('#columns, #inches').on('change keyup', function() {
            const inches = parseFloat($('#inches').val());
            const columns = parseFloat($('#columns').val());
            const unitPrice = parseFloat($('#unit_price').val());

            if (unitPrice && !isNaN(inches) && !isNaN(columns)) {
                const subtotal = unitPrice * inches * columns;
                $('#subtotal').val(subtotal);

                calculateVatAndNetTotal();
            }
        });

        $('#specific_input, #box_input, #discount_percentage, #vat').change(function() {
            calculateVatAndNetTotal();
        });

        $('#specific_input').change(function() {
            if ($(this).is(':checked')) {
                const subtotal = parseFloat($('#subtotal').val()) || 0; 
                $.ajax({
                    url: '[[=URL("default", "get_specific_rate")]]',
                    method: 'GET',
                    success: function(response) {
                        if (response.rate !== null) {
                            const specificCharge = response.rate / 100; 
                            const specificValue = subtotal * specificCharge; 
                            $('#specific').prop('readonly', true).val(specificValue); 
                            calculateVatAndNetTotal(); 
                        }
                    },
                    error: function() {
                        alert('Error fetching specific rate.');
                    }
                });
            } else {
                $('#specific').prop('readonly', true).val(''); 
                calculateVatAndNetTotal(); 
            }
        });

        $('#box_input').change(function() {
            if ($(this).is(':checked')) {
                $.ajax({
                    url: '[[=URL("default", "get_box_rate")]]',
                    method: 'GET',
                    success: function(response) {
                        if (response.rate !== null) {
                            const boxCharge = response.rate; 
                            $('#box').prop('readonly', true).val(boxCharge);
                            calculateVatAndNetTotal();
                        }
                    },
                    error: function() {
                        alert('Error fetching box rate.');
                    }
                });
            } else {
                $('#box').prop('readonly', true).val('');
                calculateVatAndNetTotal();
            }
        });

        $('#vat').on('keyup blur', function(e) {
            const vatPercentage = (parseInt($(this).val()) / 100) || 0; 
            const grossTotal = parseFloat($('#gross_total').val());

            const vatAmount = grossTotal * vatPercentage;
            $('#vat_amount').val(vatAmount); 
            const netTotal = grossTotal + vatAmount;
            $('#net_total').val(netTotal); 
        });

        $('#discount_percentage').on('keyup blur', function(e) {
            const discountPercentage = parseInt($(this).val()) / 100;
            const subtotal = parseFloat($('#subtotal').val());
            const discountAmount = subtotal * discountPercentage;
            const discountedPrice = subtotal - discountAmount;

            $('#discount_amount').val(discountAmount); 
            $('#gross_total').val(discountedPrice); 
            $('#net_total').val(discountedPrice);

            if ($('#vat_input').is(':checked')) {
                const vatPercentage = parseInt($('#vat').val()) / 100;
                const vatAmount = discountedPrice * vatPercentage;
                $('#vat_amount').val(vatAmount); 
                $('#net_total').val(discountedPrice + vatAmount); 
            }
        });

        $('#previewBtn').on('click', function () {
            var startDate = new Date($('#start_date').val());
            var endDate = new Date($('#end_date').val());
            var newsSupplement = $('#news_supplement').val();
            var pageType = $('#page_type').val();
            var pageName = $('#page_name').val();
            var colorType = $('#color_type').val();
            const inches = parseFloat($('#inches').val());
            const columns = parseFloat($('#columns').val());
            const unitPrice = parseFloat($('#unit_price').val());
            console.log(colorType)
            console.log(unitPrice)
            console.log(inches)
            console.log(columns)

            if (!startDate || !endDate) {
                alert("Please select both start and end dates.");
                return;
            }

            if (startDate > endDate) {
                alert("Start date cannot be after the end date.");
                return;
            }

            var $tableBody = $('#previewTable tbody');

            for (var d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                var formattedDate = d.toISOString().split('T')[0];

                // Create a new row
                var row = `
                <tr>
                    <td>${formattedDate}</td>
                    <td>${newsSupplement || 'N/A'}</td>
                    <td>${pageType || 'N/A'}</td>
                    <td>${pageName || 'N/A'}</td>
                    <td><button class="btn btn-secondary btn-sm deleteRowBtn">
                         <i class="fa-regular fa-trash-can"></i> <span class="ms-2">Delete</span></button></td>
                </tr>
            `;
                // Append the row to the table body
                $tableBody.append(row);
                
            }

            // Optionally, clear the input fields after adding rows
            $('#start_date').val('');
            $('#end_date').val('');
            $('#news_supplement').val('');
            $('#page_type').val('');
            $('#page_name').val('');
            loadTotalDates()
            // getPublishDateJson()
        });

        $('#previewTable tbody').on('click', '.deleteRowBtn', function () {
            $(this).closest('tr').remove(); // Remove the clicked row
            loadTotalDates()
            // getPublishDateJson()
        });


        $('#clearBtn').on('click', function () {
            $('#previewTable tbody').empty();
            $('#start_date, #end_date').val('');
            $('#news_supplement, #page_type, #page_name').val('').trigger("change");
            $('#previewBtn').prop('readonly', true);
            loadTotalDates()
            // getPublishDateJson()
        });


        // Date Count
        function getPublishDateJson() {
            // save json and render data on table
            var formData = [];

            // Loop through each row in the preview table
            $('#previewTable tbody tr').each(function () {
                var row = $(this);
                var publish_date = row.find('td').eq(0).text(); 
                var newsSupplement = row.find('td').eq(1).text(); 
                var pageType = row.find('td').eq(2).text(); 
                var pageName = row.find('td').eq(3).text(); 

                // Create a new object for each row
                var rowData = {
                    publish_date: publish_date,
                    news_supplement: newsSupplement,
                    page_type: pageType,
                    page_name: pageName
                };
                // Add the row data to the formData array
                formData.push(rowData);
            });

            var jsonString = JSON.stringify(formData);
            $('input[name="ad_multi"]').val(jsonString);
        }

        function loadTotalDates() {
            var totalDays = $('#previewTable tbody tr').length;



            if (totalDays <= 0) {
                $('.enter').text('Publish Date Advertise  [0 day]');
            }
            if (totalDays > 0) {
                $('.enter').text(`Publish Date Advertise  [${totalDays} days]`);
            }
            if (totalDays <= 0) {
                $('.multidatevalue').text('Add Date [0 day]');
            }
            if (totalDays > 0) {
                $('.multidatevalue').text(`Add Date [${totalDays} days]`);
            }

        }

        loadTotalDates();

        // Function to validate all required fields
        function validateForm() {
            var isValid = true;
            // Check if each required field has a value
            $('#start_date, #end_date, #news_supplement, #page_type, #page_name').each(function () {
                if ($(this).val() === "") {
                    isValid = false;
                }
            });

            // Enable or disable the preview button
            $('#previewBtn').prop('readonly', !isValid);
        }

        // Call validateForm whenever an input field changes
        $('#start_date, #end_date, #news_supplement, #page_type, #page_name').on('change input', function () {
            validateForm();
        });

        $('#book_page_form').on('submit', function (event) {
            event.preventDefault();
            getPublishDateJson()
            $('#book_page_form')[0].submit();
        });

    </script>

    [[end]]